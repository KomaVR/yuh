name: üöÄ Deploy Bot & Run Locust+C-Tools (Self-Healing)

# 1) Kick off manually or on a prior failure
on:
  workflow_dispatch:
  workflow_run:
    workflows: ["üöÄ Deploy Bot & Run Locust+C-Tools (Self-Healing)"]
    types: [completed]

concurrency:
  group: bot-and-storm
  cancel-in-progress: false

jobs:
  deploy-and-storm:
    # run on your always-on self-hosted machine
    runs-on: [ self-hosted, ubuntu, x64 ]

    # only if we manually triggered or the previous run failed
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'failure')

    timeout-minutes: 60

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tcpkali iperf3 python3-venv

      - name: üî® Setup Python venv & install deps
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install discord.py locust

      - name: üöÄ Launch Discord Flooder Bot
        run: |
          # kill old bot if running
          pkill -f "python bot.py" || true

          # start the bot in background
          nohup bash -lc '
            . .venv/bin/activate
            export DISCORD_TOKEN="${{ secrets.DISCORD_TOKEN }}"
            export FLOODER_ROLE_ID="${{ secrets.FLOODER_ROLE_ID }}"
            python bot.py
          ' > bot.log 2>&1 &

      - name: ‚è±Ô∏è Give bot a sec to connect
        run: sleep 5

      - name: üî• Run distributed Locust+C-Tools storm
        run: |
          . .venv/bin/activate

          # 1) Start Locust master expecting 20 workers
          locust -f locustfile_tools.py \
            --master \
            --expect-workers 20 \
            --headless \
            --users 200 \
            --spawn-rate 20 \
            --run-time 2m &
          MASTER_PID=$!

          # 2) Give master time to bind
          sleep 5

          # 3) Start 19 workers on same host
          for i in $(seq 1 20); do
            locust -f locustfile_tools.py --worker --master-host=127.0.0.1 &
          done

          # 4) Wait for the Locust swarm to finish
          wait $MASTER_PID

      - name: ‚úÖ Done
        run: echo "Bot is running and Locust storm completed successfully."

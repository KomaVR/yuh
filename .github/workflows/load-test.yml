name: üöÄ Deploy Bot & Run Locust+C-Tools (Scheduled)

# 1) Trigger every 5 minutes, or manually
on:
  schedule:
    - cron:  '*/5 * * * *'
  workflow_dispatch:

# 2) Guarantee only one run at a time (new schedules queue until previous finishes)
concurrency:
  group: bot-and-storm
  cancel-in-progress: false

jobs:
  deploy-and-storm:
    # must be your self-hosted runner so the bot can persist after the job
    runs-on: [ self-hosted, ubuntu, x64 ]
    timeout-minutes: 60

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tcpkali iperf3 python3-venv

      - name: üî® Setup Python venv & install deps
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install discord.py locust

      - name: üöÄ Launch Discord Flooder Bot
        run: |
          pkill -f "python bot.py" || true
          nohup bash -lc '
            . .venv/bin/activate
            export DISCORD_TOKEN="${{ secrets.DISCORD_TOKEN }}"
            export FLOODER_ROLE_ID="${{ secrets.FLOODER_ROLE_ID }}"
            python bot.py
          ' > bot.log 2>&1 &

      - name: ‚è±Ô∏è Give bot a sec to connect
        run: sleep 5

      - name: üî• Run distributed Locust+C-Tools storm
        run: |
          . .venv/bin/activate

          # 1) Start Locust master expecting 20 workers
          locust -f locustfile_tools.py \
            --master \
            --expect-workers 20 \
            --headless \
            --users 200 \
            --spawn-rate 20 \
            --run-time 60m &
          MASTER_PID=$!

          # 2) Give master time to bind
          sleep 5

          # 3) Launch 19 workers
          for i in $(seq 1 20); do
            locust -f locustfile_tools.py --worker --master-host=127.0.0.1 &
          done

          # 4) Wait for the Locust swarm to finish
          wait $MASTER_PID

      - name: ‚úÖ Done
        run: echo "Bot is running and Locust storm completed."

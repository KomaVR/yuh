name: üöÄ 1 Gbps TCP/UDP Power Test (101 nodes)
on:
  workflow_dispatch:

env:
  USERS:      150000     # virtual users
  SPAWN_RATE: 20000      # users spawned per second
  RUN_TIME:   5m         # total duration

jobs:
  tcp-gbps-swarm:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Install Locust
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: üî• Launch master + 100 workers
        run: |
          # 1) Start master expecting 100 workers
          locust -f locustfile_tcp_max_gbps_fixed.py \
            --master \
            --expect-workers 100 \
            --headless \
            --users "$USERS" \
            --spawn-rate "$SPAWN_RATE" \
            --run-time "$RUN_TIME" &
          MASTER_PID=$!

          # 2) Give master time to bind
          sleep 20

          # 3) Spawn 100 workers
          for i in $(seq 1 100); do
            echo "[Swarm] Starting worker #$i"
            locust -f locustfile_tcp_max_gbps_fixed.py --worker --master-host=127.0.0.1 &
          done

          # 4) Wait for the test to finish
          wait $MASTER_PID

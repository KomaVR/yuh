name: üöÄ hping3 + Locust Packet Storm
on:
  workflow_dispatch:

env:
  USERS:      1000    # total virtual users (each will run ~1s hping bursts)
  SPAWN_RATE: 500     # users/sec
  RUN_TIME:   2m     # total duration

jobs:
  packet-storm:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üîß Install hping3 & Python
        run: |
          sudo apt-get update
          sudo apt-get install -y hping3 python3 python3-venv python3-pip

      - name: üêç Setup virtualenv & deps
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install locust

      - name: üî• Run master + 9 workers
        run: |
          . venv/bin/activate

          # 1) Master expecting 10 workers
          locust -f locustfile_hping.py \
            --master \
            --expect-workers 10 \
            --headless \
            --users "$USERS" \
            --spawn-rate "$SPAWN_RATE" \
            --run-time "$RUN_TIME" &
          MASTER_PID=$!

          # 2) give master a moment
          sleep 5

          # 3) Spawn 9 workers
          for i in $(seq 1 9); do
            locust -f locustfile_hping.py \
              --worker --master-host=127.0.0.1 &
          done

          # 4) wait for the test
          wait $MASTER_PID

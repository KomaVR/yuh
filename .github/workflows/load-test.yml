name: üöÄ Distributed TCP Load Test (101 nodes)
on:
  workflow_dispatch:

env:
  USERS:      50000    # total "users" (connections) across all nodes
  SPAWN_RATE: 5000     # spawn rate (connections/sec)
  RUN_TIME:   5m       # total run time

jobs:
  locust-swarm:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Install Locust
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: üî• Launch master + 100 workers
        run: |
          # 1) Start master (no --host), expecting 100 workers
          locust -f locustfile_tcp.py \
            --master \
            --expect-workers 100 \
            --headless \
            --users "$USERS" \
            --spawn-rate "$SPAWN_RATE" \
            --run-time "$RUN_TIME" &
          MASTER_PID=$!

          # 2) Give the master time to bind
          sleep 15

          # 3) Launch 100 workers against 127.0.0.1:5557
          for i in $(seq 1 100); do
            echo "[Swarm] Starting TCP worker #$i"
            locust -f locustfile_tcp.py --worker --master-host=127.0.0.1 &
          done

          # 4) Wait for the test to finish
          wait $MASTER_PID

name: üöÄ Deploy Bot & Run Locust+C-Tools (Scheduled)

on:
  schedule:
    - cron: '*/5 * * * *'     # every 5 minutes
  workflow_dispatch:

concurrency:
  group: bot-and-storm
  cancel-in-progress: false  # queue up if one is already running

jobs:
  deploy-and-storm:
    runs-on: [ self-hosted, ubuntu, x64 ]
    timeout-minutes: 60

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Install deps & build tcpkali
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake libssl-dev libuv1-dev \
            iperf3 python3-venv curl

          # fetch akumuli/tcpkali master tarball
          mkdir -p /tmp/tcpkali
          curl -L \
            https://github.com/akumuli/tcpkali/archive/refs/heads/master.tar.gz \
            | tar -xzC /tmp/tcpkali --strip-components=1

          # compile & install
          mkdir -p /tmp/tcpkali/build
          cd /tmp/tcpkali/build
          cmake ..
          make -j"$(nproc)"
          sudo make install

      - name: üî® Setup Python venv & install deps
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install discord.py locust

      - name: üöÄ Launch Discord Flooder Bot
        run: |
          pkill -f "python bot.py" || true
          nohup bash -lc '
            . .venv/bin/activate
            export DISCORD_TOKEN="${{ secrets.DISCORD_TOKEN }}"
            export FLOODER_ROLE_ID="${{ secrets.FLOODER_ROLE_ID }}"
            python bot.py
          ' > bot.log 2>&1 &

      - name: ‚è±Ô∏è Give bot a moment to connect
        run: sleep 5

      - name: üî• Run distributed Locust+C-Tools storm
        run: |
          . .venv/bin/activate

          # start master (expects 20 workers)
          locust -f locustfile_tools.py \
            --master \
            --expect-workers 20 \
            --headless \
            --users 200 \
            --spawn-rate 20 \
            --run-time 2m &
          MASTER_PID=$!

          sleep 5

          # spin up 19 workers
          for i in $(seq 1 19); do
            locust -f locustfile_tools.py --worker --master-host=127.0.0.1 &
          done

          wait $MASTER_PID

      - name: ‚úÖ All done
        run: echo "Bot is live and storm completed."

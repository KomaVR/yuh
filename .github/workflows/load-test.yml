name: üöÄ Distributed Locust Load Test (20 nodes)
on:
  workflow_dispatch:

env:
  # tweak these to taste
  HOST: https://restorecord-leak-search.vercel.app
  USERS: 50000        # total users across all nodes
  SPAWN_RATE: 5000    # users/sec total
  RUN_TIME: 5m       # how long to hammer

jobs:
  locust-swarm:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Install Locust
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: üî• Launch 1 master + 19 workers
        run: |
          # start the master in headless mode
          echo "[Swarm] Starting master..."
          locust -f lol2.py \
            --master \
            --headless \
            --host="$HOST" \
            --users "$USERS" \
            --spawn-rate "$SPAWN_RATE" \
            --run-time "$RUN_TIME" &
          MASTER_PID=$!

          # give it a couple seconds to bind to 127.0.0.1:8089
          sleep 5

          # now spin up 19 workers that point at the local master
          for i in $(seq 1 1900); do
            echo "[Swarm] Starting worker #$i"
            locust -f lol2.py --worker --master-host=127.0.0.1 &
          done

          # wait for the master (and thus the whole stress test) to finish
          wait $MASTER_PID

name: 🚀 Distributed Locust Load Test (20 nodes)
on:
  workflow_dispatch:

env:
  HOST: https://54.167.227.87
  USERS: 50000
  SPAWN_RATE: 5000
  RUN_TIME: 5m

jobs:
  locust-swarm:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 📦 Install Locust
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: 🔥 Launch master + 19 workers
        run: |
          # 1) Start master, expecting 20 total (1 master + 19 workers)
          locust -f lol2.py \
            --master \
            --expect-workers 19 \
            --headless \
            --host="$HOST" \
            --users "$USERS" \
            --spawn-rate "$SPAWN_RATE" \
            --run-time "$RUN_TIME" &
          MASTER_PID=$!

          # 2) Give it time to spin up its listener
          sleep 10

          # 3) Now fire up 19 workers pointing at that master
          for i in $(seq 1 19); do
            locust -f lol2.py --worker --master-host=127.0.0.1 &
          done

          # 4) Wait for the master (and the entire test) to finish
          wait $MASTER_PID

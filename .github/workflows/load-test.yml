name: üöÄ 1 Gbps TCP/UDP Power Test v2 (101 nodes)
on: workflow_dispatch

env:
  USERS:      150000
  SPAWN_RATE: 20000
  RUN_TIME:   5m

jobs:
  tcp-gbps-swarm:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v3

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with: 
            python-version: '3.11'

      - name: üì¶ Install Locust
        run: |
          python -m pip install --upgrade pip
          pip install locust

      - name: üî• Launch master + 100 workers
        run: |
          locust -f locustfile_tcp_max_gbps_v2.py \
            --master \
            --expect-workers 100 \
            --headless \
            --users "$USERS" \
            --spawn-rate "$SPAWN_RATE" \
            --run-time "$RUN_TIME" &
          MASTER_PID=$!
          sleep 20
          for i in $(seq 1 100); do
            locust -f locustfile_tcp_max_gbps_v2.py \
              --worker --master-host=127.0.0.1 &
          done
          wait $MASTER_PID

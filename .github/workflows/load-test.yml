name: üöÄ Distributed Locust Load Test

on:
  workflow_dispatch:
    inputs:
      HOST:
        description: 'Target URL to test'
        required: true
      USERS:
        description: 'Total virtual users'
        required: true
      SPAWN_RATE:
        description: 'Users spawned per second'
        required: true
      WORKERS:
        description: 'Number of worker processes'
        required: true
      RUN_TIME:
        description: 'How long to run (e.g. 5m, 1h)'
        required: true

jobs:
  locust-swarm:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Install Locust
        run: pip install locust

      - name: üî• Launch master + workers
        env:
          HOST: ${{ github.event.inputs.HOST }}
          USERS: ${{ github.event.inputs.USERS }}
          SPAWN_RATE: ${{ github.event.inputs.SPAWN_RATE }}
          WORKERS: ${{ github.event.inputs.WORKERS }}
          RUN_TIME: ${{ github.event.inputs.RUN_TIME }}
        run: |
          TOTAL=$((WORKERS + 1))
          locust -f lol2.py \
            --master \
            --expect-workers "${TOTAL}" \
            --headless \
            --host="${HOST}" \
            --users "${USERS}" \
            --spawn-rate "${SPAWN_RATE}" \
            --run-time "${RUN_TIME}" &
          MASTER_PID=$!

          sleep 10

          for i in $(seq 1 "${WORKERS}"); do
            locust -f lol2.py --worker --master-host=127.0.0.1 &
          done

          wait $MASTER_PID
